# DO NOT EDIT. Generated with:
#
#    devctl
#
#    https://github.com/giantswarm/devctl/blob/d3b676f861bcff1d59eb4ab01edf5adb345371d3/pkg/gen/input/workflows/internal/file/update_chart.yaml.template
#

name: Create Update Chart PR

on:
  push:
    branches:
      - 'main#update-chart'
      - 'master#update-chart'
  workflow_call:
    inputs:
      branch:
        required: true
        type: string

permissions: {}

jobs:
  update-chart:
    uses: giantswarm/github-workflows/.github/workflows/update-chart.yaml@main
    with:
      branch: ${{ inputs.branch }}
    secrets:
      TAYLORBOT_GITHUB_ACTION: ${{ secrets.TAYLORBOT_GITHUB_ACTION }}
    permissions:
      contents: write
    needs:
      - gather_facts
    if: ${{ needs.gather_facts.outputs.skip != 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ needs.gather_facts.outputs.branch }}
      - name: Install vendir
        run: |
          wget https://github.com/vmware-tanzu/carvel-vendir/releases/download/v0.32.2/vendir-linux-amd64 -O /tmp/vendir
          SHA_VENDIR=`shasum -a 256 /tmp/vendir | cut -d ' ' -f1`
          [ "$SHA_VENDIR" != "f5d3cbbd8135d2d48f4f007b8a933bd60b2a827d68f4001c5d1774392fa7b3f2" ] && echo "invalid vendir binary" && exit 1
          sudo mv /tmp/vendir /usr/local/bin/vendir && chmod a+x /usr/local/bin/vendir
      - name: Run update
        run: |
          # Define chart_dir
          repository="${{ needs.gather_facts.outputs.repo_name }}"
          chart="helm/${repository}"

          # Check chart directory.
          if [ ! -d "${chart}" ]
          then
            echo "Could not find chart directory '${chart}', removing app suffix."

            # Remove app suffix.
            chart="helm/${repository%-app}"

            if [ ! -d "${chart}" ]
            then
              # Print error.
              echo "Could not find chart directory '${chart}', doing nothing."
              exit 1
            fi
          fi

          make update-chart APPLICATION="${chart}"
      - name: Set up git identity
        run: |
          git config --local user.email "dev@giantswarm.io"
          git config --local user.name "taylorbot"
      - name: Create update commit
        run: |
          git add -A
          git commit -m "Automated update from upstream"
      - name: Push changes
        env:
          remote_repo: "https://${{ github.actor }}:${{ secrets.TAYLORBOT_GITHUB_ACTION }}@github.com/${{ github.repository }}.git"
        run: |
          git push "${remote_repo}" HEAD:${{ needs.gather_facts.outputs.branch }}
      - name: Update PR
        env:
          GITHUB_TOKEN: "${{ secrets.TAYLORBOT_GITHUB_ACTION }}"
          base: "${{ needs.gather_facts.outputs.base }}"
        run: |
          gh pr create --title "Automated update from upstream"  --label "automated-update" --assignee ${{ github.actor }} --base ${{ env.base }} --head ${{ needs.gather_facts.outputs.branch }} --body-file - << EOF
          This PR was created by the \`update-chart\` GitHub Actions workflow.
          - [ ] **:warning: All tests are passing**
          - [ ] **:warning: The CHANGELOG.md file has been updated**
          - [ ] **:warning: Additional changes in ignored files (see vendir.yml) have been adapted and migrated**
          EOF
